<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SONA-OS | Habitat Interface</title>
    
    <!-- PyScript -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <script type="json" id="pyscript-config">{"interpreter": "micropython"}</script>

    <!-- Map & Fonts -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --bg: #050505; --panel: #111; --text: #e0e0e0; --accent: #00ff41; --alert: #ff0055; --sona: #00ffff; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'JetBrains Mono', monospace; height: 100dvh; overflow: hidden; user-select: none; }
        
        /* LAYOUT */
        #main-ui { display: flex; flex-direction: column; height: 100%; }
        header { flex: 0 0 50px; border-bottom: 1px solid #333; display: flex; align-items: center; padding: 0 15px; justify-content: space-between; font-size: 0.8rem; }
        
        /* DASHBOARD */
        .dashboard { flex: 0 0 auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; z-index: 10; background: var(--bg); }
        .card { background: var(--panel); border: 1px solid #333; padding: 15px; border-radius: 8px; width: 100%; box-sizing: border-box; }
        
        /* AVATAR SECTION */
        .avatar-container { display: flex; align-items: flex-start; gap: 15px; }
        .sona-img { 
            width: 80px; height: 80px; 
            border-radius: 8px; /* å››è§’ã„ã‚«ãƒ¼ãƒ‰é¢¨ã«å¤‰æ›´ */
            border: 2px solid var(--sona); 
            object-fit: cover; 
            background: #000;
            transition: all 0.3s ease;
        }
        /* å±æ©Ÿçš„çŠ¶æ³ã§ç”»åƒã‚’èµ¤ãç‚¹æ»…ã•ã›ã‚‹ã‚¯ãƒ©ã‚¹ */
        .critical-alert { animation: pulse-red 1s infinite; border-color: var(--alert); }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(255, 0, 85, 0.7); } 70% { box-shadow: 0 0 10px 10px rgba(255, 0, 85, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 0, 85, 0); } }

        .sona-msg { font-size: 0.85rem; line-height: 1.4; color: var(--sona); display: flex; align-items: center; min-height: 80px; }

        /* BARS */
        .metric-row { display: flex; align-items: center; margin-top: 10px; font-size: 0.8rem; }
        .bar-bg { flex: 1; height: 6px; background: #333; margin: 0 10px; }
        .bar-fill { height: 100%; background: var(--accent); width: 100%; transition: width 0.5s; }

        /* MAP & DRONE */
        #map-container { flex: 1; position: relative; border-top: 2px solid var(--sona); min-height: 200px; }
        #map { height: 100%; width: 100%; background: #222; }
        .drone-overlay { position: absolute; top: 10px; right: 10px; z-index: 999; background: rgba(0,0,0,0.8); padding: 5px 10px; font-size: 0.7rem; border: 1px solid var(--accent); color: var(--accent); }
        .drone-icon { font-size: 24px; animation: pulse 1s infinite; text-shadow: 0 0 5px #0f0; }

        button { background: #333; color: #fff; border: 1px solid #fff; padding: 12px; cursor: pointer; width: 100%; margin-top: 10px; font-weight: bold; transition: 0.2s; font-family: inherit; }
        button:active { background: #fff; color: #000; }
    </style>
</head>
<body>

    <div id="main-ui">
        <header>
            <div><i class="fas fa-microchip"></i> <b>SONA-OS v0.0.3</b></div>
            <div id="clock">SYS: ACTIVE</div>
        </header>

        <!-- SONA (Agent) -->
        <div class="dashboard">
            <div class="card" style="border-color: var(--sona);">
                <div class="avatar-container">
                    <!-- IMAGE: FALLBACK TO NOMINAL IF MISSING -->
                    <img id="sona-face" src="./assets/avatar/nominal.png" class="sona-img" 
                         onerror="this.onerror=null; this.src='./assets/avatar/nominal.png';">
                    
                    <div id="sona-msg" class="sona-msg">System initialized.<br>Monitoring Habitat metrics.</div>
                </div>
                
                <div style="margin-top:15px; border-top:1px dashed #333; padding-top:10px;">
                    <div class="metric-row">H2O <div class="bar-bg"><div id="b-water" class="bar-fill"></div></div> <span id="v-water">100%</span></div>
                    <div class="metric-row">PWR <div class="bar-bg"><div id="b-power" class="bar-fill"></div></div> <span id="v-power">100%</span></div>
                </div>
                <!-- ãƒ‡ãƒ¢ç”¨: æ™‚é–“ã‚’çµŒéã•ã›ã¦è¡¨æƒ…å¤‰åŒ–ã‚’è¦‹ã›ã‚‹ãƒœã‚¿ãƒ³ -->
                <button py-click="tick">â³ FAST FORWARD (+1 Hour)</button>
            </div>
        </div>

        <!-- AETOS (Map) -->
        <div id="map-container">
            <div id="map"></div>
            <div class="drone-overlay">
                ğŸš LINK: <span id="drone-status">STANDBY</span>
            </div>
        </div>
    </div>

    <!-- JS Map Interface -->
    <script>
        let map, droneMarker;
        const HOME = [35.8617, 139.9711]; // Kashiwa Base
        
        window.onload = function() { setTimeout(initMap, 100); };

        function initMap() {
            map = L.map('map', {zoomControl: false, attributionControl: false}).setView(HOME, 15);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                subdomains: 'abcd', maxZoom: 19
            }).addTo(map);
            
            const icon = L.divIcon({className: 'drone-icon', html: 'ğŸš'});
            droneMarker = L.marker(HOME, {icon: icon}).addTo(map);
        }

        function moveDrone(lat, lon) { 
            if(droneMarker) { droneMarker.setLatLng([lat, lon]); map.panTo([lat, lon]); }
        }
    </script>

    <!-- PYTHON LOGIC -->
    <script type="py">
        from pyscript import document
        import random
        import asyncio
        import js

        # Initial State
        state = {"water": 100.0, "power": 100.0, "is_flying": False}

        # --- AVATAR CONTROLLER ---
        def update_avatar(w, p, is_flying):
            """
            ç†±åŠ›å­¦(w, p)ã‚’æ„Ÿæƒ…(img)ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã™ã‚‹ã‚³ã‚¢é–¢æ•°
            """
            img_el = document.getElementById("sona-face")
            base_path = "./assets/avatar/"
            
            # Logic: Priority Queue
            if is_flying:
                # æ€è€ƒä¸­/å¾…æ©Ÿä¸­
                target = "compute.png"
                img_el.classList.remove("critical-alert")
            elif w < 20 or p < 20:
                # å±æ©Ÿçš„çŠ¶æ³ (æ³£ãé¡”)
                target = "critical.png"
                img_el.classList.add("critical-alert")
            elif w < 40 or p < 40:
                # è² è·å¢—å¤§ (æ±—/ç„¦ã‚Š)
                target = "strain.png"
                img_el.classList.remove("critical-alert")
            elif w > 80 and p > 80:
                # æœ€é©çŠ¶æ…‹ (ç¬‘é¡”/ãƒ‰ãƒ¤)
                target = "optimal.png"
                img_el.classList.remove("critical-alert")
            else:
                # é€šå¸¸ (çœŸé¡”)
                target = "nominal.png"
                img_el.classList.remove("critical-alert")

            # Update Source
            img_el.src = base_path + target

        # --- AETOS DRONE LOGIC ---
        async def call_drone_delivery():
            if state["is_flying"]: return
            state["is_flying"] = True
            
            update_avatar(state["water"], state["power"], True) # Face -> Compute
            
            document.getElementById("drone-status").innerText = "LAUNCHING..."
            document.getElementById("drone-status").style.color = "#00ff41"
            
            # Flight Simulation
            home = (35.8617, 139.9711)
            depot = (35.8650, 139.9750)
            steps = 30
            
            # Go
            for i in range(steps):
                lat = home[0] + (depot[0] - home[0]) * (i/steps)
                lon = home[1] + (depot[1] - home[1]) * (i/steps)
                js.moveDrone(lat, lon)
                await asyncio.sleep(0.05)
            
            document.getElementById("drone-status").innerText = "REFILLING..."
            await asyncio.sleep(1)
            
            # Return
            for i in range(steps):
                lat = depot[0] - (depot[0] - home[0]) * (i/steps)
                lon = depot[1] - (depot[1] - home[1]) * (i/steps)
                js.moveDrone(lat, lon)
                await asyncio.sleep(0.05)
                
            document.getElementById("drone-status").innerText = "DELIVERED"
            state["is_flying"] = False
            
            # Refill Resources
            state["water"] = 100.0
            state["power"] = 100.0
            
            update_ui()
            set_msg("è£œçµ¦å®Œäº†ã€‚\nç”Ÿå­˜ç¢ºç‡ã¯æ­£å¸¸å€¤ã«æˆ»ã‚Šã¾ã—ãŸã€‚", "#00ffff")

        # --- CORE SYSTEM ---
        def update_ui():
            w = state['water']
            p = state['power']
            
            # Bars
            document.getElementById("b-water").style.width = f"{w}%"
            document.getElementById("v-water").innerText = f"{int(w)}%"
            document.getElementById("b-water").style.background = "#ff0055" if w < 20 else "#00ff41"

            document.getElementById("b-power").style.width = f"{p}%"
            document.getElementById("v-power").innerText = f"{int(p)}%"
            document.getElementById("b-power").style.background = "#ff0055" if p < 20 else "#00ff41"

            # Avatar Update (Link Logic to Emotion)
            update_avatar(w, p, state["is_flying"])

        def set_msg(msg, color="#e0e0e0"):
            el = document.getElementById("sona-msg")
            el.innerText = msg
            el.style.color = color

        def tick(e):
            # Simulation Logic
            is_sunny = random.random() > 0.5
            
            # Decrease Water
            state["water"] = max(0, state["water"] - 15)
            
            # Power Flux
            if is_sunny:
                state["power"] = min(100, state["power"] + 10)
                status = "ï¼ˆæ—¥ç…§ã‚ã‚Šâ˜€ï¸ï¼‰"
            else:
                state["power"] = max(0, state["power"] - 15)
                status = "ï¼ˆæ—¥ç…§ãªã—â˜ï¸ï¼‰"

            # Emergency Check
            if state["water"] < 20 or state["power"] < 20:
                set_msg("è­¦å‘Šï¼šãƒªã‚½ãƒ¼ã‚¹æ¯æ¸‡ã€‚\nAetosã«ç·Šæ€¥é…é€ã‚’è¦è«‹ä¸­...", "#ff0055")
                asyncio.create_task(call_drone_delivery())
            else:
                # Normal Messages
                if state["water"] < 40:
                    set_msg("æ°´æ®‹é‡ãŒä½ä¸‹ã—ã¦ã„ã¾ã™ã€‚\nç¯€æ°´ã‚’æ¨å¥¨ã—ã¾ã™ã€‚", "#ffaa00")
                elif state["power"] > 90:
                    set_msg(f"ã‚¨ãƒãƒ«ã‚®ãƒ¼å……å¡«å®Œäº†ã€‚\næœ€é«˜åŠ¹ç‡ã§ç¨¼åƒä¸­ã€‚{status}", "#00ff41")
                else:
                    set_msg(f"ã‚·ã‚¹ãƒ†ãƒ æ­£å¸¸ã€‚\nç’°å¢ƒç¶­æŒãƒ¢ãƒ¼ãƒ‰ç¨¼åƒä¸­ã€‚{status}", "#00ffff")
            
            update_ui()

    </script>
</body>
</html>
