<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SONAM + AETOS | Integrated Habitat</title>
    
    <!-- PyScript -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <script type="json" id="pyscript-config">{"interpreter": "micropython"}</script>

    <!-- Map & Fonts -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --bg: #050505; --panel: #111; --text: #e0e0e0; --accent: #00ff41; --alert: #ff0055; --sona: #00ffff; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'JetBrains Mono', monospace; height: 100dvh; overflow: hidden; user-select: none; }
        
        /* LAYOUT: Flexbox for stability */
        #main-ui { display: flex; flex-direction: column; height: 100%; }
        
        /* 1. HEADER (Fixed) */
        header { flex: 0 0 50px; border-bottom: 1px solid #333; display: flex; align-items: center; padding: 0 15px; justify-content: space-between; font-size: 0.8rem; }
        
        /* 2. DASHBOARD (Auto Height) */
        .dashboard { flex: 0 0 auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; z-index: 10; background: var(--bg); }
        .card { background: var(--panel); border: 1px solid #333; padding: 15px; border-radius: 8px; width: 100%; box-sizing: border-box; }
        
        /* 3. MAP CONTAINER (Fill Remaining Space) */
        #map-container { flex: 1; position: relative; border-top: 2px solid var(--sona); min-height: 200px; }
        #map { height: 100%; width: 100%; background: #222; } /* Fallback color */
        
        /* UI ELEMENTS */
        .metric-row { display: flex; align-items: center; margin-bottom: 10px; font-size: 0.8rem; }
        .bar-bg { flex: 1; height: 6px; background: #333; margin: 0 10px; }
        .bar-fill { height: 100%; background: var(--accent); width: 100%; transition: width 0.5s; }
        
        .sona-img { width: 60px; height: 60px; border-radius: 50%; border: 2px solid var(--sona); object-fit: cover; float: left; margin-right: 15px; }
        .sona-msg { font-size: 0.85rem; line-height: 1.4; color: var(--sona); min-height: 60px; }

        /* DRONE OVERLAY */
        .drone-overlay { position: absolute; top: 10px; right: 10px; z-index: 999; background: rgba(0,0,0,0.8); padding: 5px 10px; font-size: 0.7rem; border: 1px solid var(--accent); color: var(--accent); }
        .drone-icon { font-size: 24px; animation: pulse 1s infinite; text-shadow: 0 0 5px #0f0; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        button { background: #333; color: #fff; border: 1px solid #fff; padding: 8px 10px; cursor: pointer; width: 100%; margin-top: 5px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="main-ui">
        <header>
            <div><i class="fas fa-network-wired"></i> <b>SONAM x AETOS</b></div>
            <div id="clock">Day 01 12:00</div>
        </header>

        <!-- SONA (Agent) -->
        <div class="dashboard">
            <div class="card" style="border-color: var(--sona);">
                <img src="./sona.png" class="sona-img" onerror="this.src='https://api.dicebear.com/7.x/bottts/svg?seed=Sona'">
                <div id="sona-msg" class="sona-msg">System Online.<br>Monitoring Habitat.</div>
                
                <div style="clear:both; margin-top:10px; border-top:1px dashed #333; padding-top:10px;">
                    <div class="metric-row">H2O <div class="bar-bg"><div id="b-water" class="bar-fill"></div></div> <span id="v-water">100%</span></div>
                    <div class="metric-row">PWR <div class="bar-bg"><div id="b-power" class="bar-fill"></div></div> <span id="v-power">100%</span></div>
                </div>
                <button py-click="tick">‚è≥ FAST FORWARD (Time)</button>
            </div>
        </div>

        <!-- AETOS (Map) -->
        <div id="map-container">
            <div id="map"></div>
            <div class="drone-overlay">
                üöÅ AETOS LINK: <span id="drone-status">STANDBY</span>
            </div>
        </div>
    </div>

    <!-- JS Map Interface -->
    <script>
        let map, droneMarker;
        const HOME = [35.8617, 139.9711]; // Kashiwa Base
        const DEPOT = [35.8650, 139.9750]; 

        window.onload = function() {
            setTimeout(initMap, 100); // Slight delay to ensure layout
        };

        function initMap() {
            // Dark Matter Tile
            map = L.map('map', {zoomControl: false}).setView(HOME, 15);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CartoDB',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);
            
            const icon = L.divIcon({className: 'drone-icon', html: 'üöÅ'});
            droneMarker = L.marker(HOME, {icon: icon}).addTo(map);
            
            // Re-render map size
            map.invalidateSize();
        }

        function moveDrone(lat, lon) { 
            if(droneMarker) {
                droneMarker.setLatLng([lat, lon]); 
                map.panTo([lat, lon]);
            }
        }
    </script>

    <!-- PYTHON LOGIC -->
    <script type="py">
        from pyscript import document
        import random
        import asyncio
        import js

        state = {"water": 100.0, "power": 100.0, "is_flying": False}

        # --- AETOS DRONE LOGIC ---
        async def call_drone_delivery():
            if state["is_flying"]: return
            state["is_flying"] = True
            
            document.getElementById("drone-status").innerText = "LAUNCHING..."
            document.getElementById("drone-status").style.color = "#00ff41"
            
            # Flight Simulation
            home = (35.8617, 139.9711)
            depot = (35.8650, 139.9750)
            steps = 40
            
            # Go to Depot
            for i in range(steps):
                lat = home[0] + (depot[0] - home[0]) * (i/steps)
                lon = home[1] + (depot[1] - home[1]) * (i/steps)
                js.moveDrone(lat, lon)
                await asyncio.sleep(0.05)
            
            document.getElementById("drone-status").innerText = "PICKING UP..."
            await asyncio.sleep(1)
            
            # Return Home
            for i in range(steps):
                lat = depot[0] - (depot[0] - home[0]) * (i/steps)
                lon = depot[1] - (depot[1] - home[1]) * (i/steps)
                js.moveDrone(lat, lon)
                await asyncio.sleep(0.05)
                
            document.getElementById("drone-status").innerText = "DELIVERED"
            state["is_flying"] = False
            
            # Resource Refill
            state["water"] = 100.0
            update_ui()
            talk("Áâ©Ë≥á„ÅåÂ±ä„Åç„Åæ„Åó„ÅüÔºÅ„ÅÇ„Çä„Åå„Å®„ÅÜ„ÄÅAetos„ÄÇ")

        # --- SONA LOGIC ---
        def update_ui():
            document.getElementById("b-water").style.width = f"{state['water']}%"
            document.getElementById("v-water").innerText = f"{int(state['water'])}%"
            document.getElementById("b-power").style.width = f"{state['power']}%"

        def talk(custom_msg=None):
            if custom_msg:
                msg = custom_msg
                color = "#00ffff"
            elif state["water"] < 30:
                msg = "Ê∞¥„ÅåÂàá„Çå„Åù„ÅÜ„Åß„Åô... „Éâ„É≠„Éº„É≥„ÇíÊâãÈÖç„Åó„Åæ„Åô„ÅãÔºü\n(Ëá™ÂãïÁô∫Ê≥®„Ç∑„Çπ„ÉÜ„É†Ëµ∑Âãï)"
                color = "#ff0055"
                # Trigger Drone Automatically
                asyncio.create_task(call_drone_delivery())
            else:
                msg = "„Ç∑„Çπ„ÉÜ„É†Ê≠£Â∏∏„ÄÇÂø´ÈÅ©„Å™Áí∞Â¢É„Åß„Åô„ÄÇ"
                color = "#e0e0e0"
            
            el = document.getElementById("sona-msg")
            el.innerText = msg
            el.style.color = color

        def tick(e):
            # Consume Resources
            state["water"] = max(0, state["water"] - 20)
            state["power"] = max(0, state["power"] - 10)
            update_ui()
            talk()

    </script>
</body>
</html>
