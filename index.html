<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SONAM + AETOS | Integrated Habitat</title>
    
    <!-- PyScript -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <script type="json" id="pyscript-config">{"interpreter": "micropython"}</script>

    <!-- Map & Fonts -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --bg: #050505; --panel: #111; --text: #e0e0e0; --accent: #00ff41; --alert: #ff0055; --sona: #00ffff; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'JetBrains Mono', monospace; height: 100dvh; overflow: hidden; user-select: none; }
        
        /* LAYOUT */
        #main-ui { display: flex; flex-direction: column; height: 100%; }
        header { flex: 0 0 50px; border-bottom: 1px solid #333; display: flex; align-items: center; padding: 0 15px; justify-content: space-between; font-size: 0.8rem; }
        
        /* DASHBOARD */
        .dashboard { flex: 0 0 auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; z-index: 10; background: var(--bg); }
        .card { background: var(--panel); border: 1px solid #333; padding: 15px; border-radius: 8px; width: 100%; box-sizing: border-box; }
        
        /* MAP */
        #map-container { flex: 1; position: relative; border-top: 2px solid var(--sona); min-height: 200px; }
        #map { height: 100%; width: 100%; background: #222; }
        
        /* UI ELEMENTS */
        .metric-row { display: flex; align-items: center; margin-bottom: 10px; font-size: 0.8rem; }
        .bar-bg { flex: 1; height: 6px; background: #333; margin: 0 10px; }
        .bar-fill { height: 100%; background: var(--accent); width: 100%; transition: width 0.5s; }
        
        .sona-img { width: 60px; height: 60px; border-radius: 50%; border: 2px solid var(--sona); object-fit: cover; float: left; margin-right: 15px; }
        .sona-msg { font-size: 0.85rem; line-height: 1.4; color: var(--sona); min-height: 60px; display: flex; align-items: center; }

        /* DRONE OVERLAY */
        .drone-overlay { position: absolute; top: 10px; right: 10px; z-index: 999; background: rgba(0,0,0,0.8); padding: 5px 10px; font-size: 0.7rem; border: 1px solid var(--accent); color: var(--accent); }
        .drone-icon { font-size: 24px; animation: pulse 1s infinite; text-shadow: 0 0 5px #0f0; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        button { background: #333; color: #fff; border: 1px solid #fff; padding: 8px 10px; cursor: pointer; width: 100%; margin-top: 5px; font-weight: bold; transition: 0.2s; }
        button:active { background: #fff; color: #000; }
    </style>
</head>
<body>

    <div id="main-ui">
        <header>
            <div><i class="fas fa-network-wired"></i> <b>SONAM x AETOS</b></div>
            <div id="clock">Day 01 12:00</div>
        </header>

        <!-- SONA (Agent) -->
        <div class="dashboard">
            <div class="card" style="border-color: var(--sona);">
                <img src="./sona.png" class="sona-img" onerror="this.src='https://api.dicebear.com/7.x/bottts/svg?seed=Sona'">
                <div id="sona-msg" class="sona-msg">System Online.<br>Monitoring Habitat.</div>
                
                <div style="clear:both; margin-top:10px; border-top:1px dashed #333; padding-top:10px;">
                    <div class="metric-row">H2O <div class="bar-bg"><div id="b-water" class="bar-fill"></div></div> <span id="v-water">100%</span></div>
                    <div class="metric-row">PWR <div class="bar-bg"><div id="b-power" class="bar-fill"></div></div> <span id="v-power">100%</span></div>
                </div>
                <button py-click="tick">‚è≥ FAST FORWARD (Time)</button>
            </div>
        </div>

        <!-- AETOS (Map) -->
        <div id="map-container">
            <div id="map"></div>
            <div class="drone-overlay">
                üöÅ AETOS LINK: <span id="drone-status">STANDBY</span>
            </div>
        </div>
    </div>

    <!-- JS Map Interface -->
    <script>
        let map, droneMarker;
        const HOME = [35.8617, 139.9711]; // Kashiwa Base
        const DEPOT = [35.8650, 139.9750]; 

        window.onload = function() { setTimeout(initMap, 100); };

        function initMap() {
            map = L.map('map', {zoomControl: false}).setView(HOME, 15);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap', subdomains: 'abcd', maxZoom: 19
            }).addTo(map);
            
            const icon = L.divIcon({className: 'drone-icon', html: 'üöÅ'});
            droneMarker = L.marker(HOME, {icon: icon}).addTo(map);
            map.invalidateSize();
        }

        function moveDrone(lat, lon) { 
            if(droneMarker) { droneMarker.setLatLng([lat, lon]); map.panTo([lat, lon]); }
        }
    </script>

    <!-- PYTHON LOGIC -->
    <script type="py">
        from pyscript import document
        import random
        import asyncio
        import js

        # Initial State
        state = {"water": 100.0, "power": 100.0, "is_flying": False}

        # --- AETOS DRONE LOGIC ---
        async def call_drone_delivery():
            if state["is_flying"]: return
            state["is_flying"] = True
            
            # Status Update
            document.getElementById("drone-status").innerText = "LAUNCHING..."
            document.getElementById("drone-status").style.color = "#00ff41"
            
            # Flight Path
            home = (35.8617, 139.9711)
            depot = (35.8650, 139.9750)
            steps = 40
            
            # Go to Depot
            for i in range(steps):
                lat = home[0] + (depot[0] - home[0]) * (i/steps)
                lon = home[1] + (depot[1] - home[1]) * (i/steps)
                js.moveDrone(lat, lon)
                await asyncio.sleep(0.05)
            
            document.getElementById("drone-status").innerText = "LOADING CARTRIDGE..."
            await asyncio.sleep(1)
            
            # Return Home
            for i in range(steps):
                lat = depot[0] - (depot[0] - home[0]) * (i/steps)
                lon = depot[1] - (depot[1] - home[1]) * (i/steps)
                js.moveDrone(lat, lon)
                await asyncio.sleep(0.05)
                
            document.getElementById("drone-status").innerText = "DELIVERED"
            state["is_flying"] = False
            
            # === PHYSICAL RESOURCE SWAP ===
            state["water"] = 100.0
            state["power"] = 100.0 # Battery Swapped!
            
            update_ui()
            set_msg("Ê∞¥„Çø„É≥„ÇØ„Å®„Éê„ÉÉ„ÉÜ„É™„Éº„Çí‰∫§Êèõ„Åó„Åæ„Åó„Åü„ÄÇ\n„ÅÇ„Çä„Åå„Å®„ÅÜ„ÄÅAetos„ÄÇ", "#00ffff")

        # --- SONA LOGIC ---
        def update_ui():
            # Water Bar
            w = state['water']
            document.getElementById("b-water").style.width = f"{w}%"
            document.getElementById("v-water").innerText = f"{int(w)}%"
            document.getElementById("b-water").style.background = "#ff0055" if w < 20 else "#00ff41"

            # Power Bar
            p = state['power']
            document.getElementById("b-power").style.width = f"{p}%"
            document.getElementById("v-power").innerText = f"{int(p)}%"
            document.getElementById("b-power").style.background = "#ff0055" if p < 20 else "#00ff41"

        def set_msg(msg, color="#e0e0e0"):
            el = document.getElementById("sona-msg")
            el.innerText = msg
            el.style.color = color

        def tick(e):
            # 1. Weather Simulation (Solar)
            is_sunny = random.random() > 0.6 # 40% Chance of Sun
            
            # 2. Consumption
            state["water"] = max(0, state["water"] - 10)
            
            # 3. Power Logic
            if is_sunny:
                # Generation > Consumption
                state["power"] = min(100, state["power"] + 15)
                weather_status = "ÔºàÁô∫Èõª‰∏≠...‚òÄÔ∏èÔºâ"
            else:
                # Consumption Only
                state["power"] = max(0, state["power"] - 10)
                weather_status = ""

            # 4. Emergency Check
            if state["water"] < 20 or state["power"] < 20:
                set_msg("„É™„ÇΩ„Éº„ÇπÊÆãÈáè„ÅåÂç±Èô∫Âüü„Åß„Åô...ÔºÅ\nAetos„Å´Á∑äÊÄ•ÈÖçÈÄÅ„ÇíË¶ÅË´ã„Åó„Åæ„Åô„ÄÇ", "#ff0055")
                # Auto Order
                asyncio.create_task(call_drone_delivery())
            else:
                # Normal Operation
                if is_sunny:
                    set_msg(f"Â§™ÈôΩÂÖâ„Éë„Éç„É´ÂäπÁéáËâØÂ•Ω„ÄÇ\n„Ç®„Éç„É´„ÇÆ„Éº„ÉÅ„É£„Éº„Ç∏‰∏≠...{weather_status}", "#e0e0e0")
                else:
                    set_msg("„Ç∑„Çπ„ÉÜ„É†Ê≠£Â∏∏„ÄÇÂø´ÈÅ©„Å™Áí∞Â¢É„Åß„Åô„ÄÇ", "#e0e0e0")
            
            update_ui()

    </script>
</body>
</html>
