<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SONA-OS | Habitat Interface</title>
    
    <!-- PyScript -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <script type="json" id="pyscript-config">{"interpreter": "micropython"}</script>

    <!-- Map & Fonts -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --bg: #050505; --panel: #111; --text: #e0e0e0; --accent: #00ff41; --alert: #ff0055; --sona: #00ffff; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'JetBrains Mono', monospace; min-height: 100dvh; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        /* LAYOUT CONTAINER */
        #main-ui { 
            max-width: 600px; /* PCで見てもスマホサイズに */
            margin: 0 auto;
            padding: 10px;
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            padding-bottom: 50px; /* スクロール余白 */
        }

        /* HEADER */
        header { 
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 5px;
            font-size: 0.8rem; color: #888;
        }
        
        /* 1. HERO SECTION (Avatar + Status) */
        .hero-card {
            background: var(--panel); 
            border: 1px solid var(--sona); 
            border-radius: 12px; 
            padding: 20px; 
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.1);
        }

        .avatar-area {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        /* 顔をデカく！ */
        .sona-img { 
            width: 130px; height: 130px; /* デカくした */
            border-radius: 12px;
            border: 2px solid var(--sona); 
            object-fit: cover; 
            background: #000;
            flex-shrink: 0;
            image-rendering: pixelated; /* ドット絵をくっきり */
            box-shadow: 0 0 10px var(--sona);
        }
        
        .sona-msg { 
            font-size: 0.9rem; 
            line-height: 1.5; 
            color: #fff; 
            text-shadow: 0 0 5px rgba(0,255,255,0.5);
            flex: 1;
        }

        /* BARS (Thicker) */
        .metrics-area {
            background: #000;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
        }
        .metric-row { display: flex; align-items: center; margin-bottom: 12px; font-size: 0.85rem; font-weight: bold; }
        .metric-row:last-child { margin-bottom: 0; }
        .bar-bg { flex: 1; height: 12px; background: #222; margin: 0 12px; border-radius: 6px; overflow: hidden; border: 1px solid #444; }
        .bar-fill { height: 100%; background: var(--accent); width: 100%; transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .val-text { width: 45px; text-align: right; }

        /* 2. MAP WIDGET (Square) */
        .map-card {
            background: var(--panel);
            border: 1px solid #444;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            /* 正方形にする */
            aspect-ratio: 1 / 1; 
            width: 100%;
        }
        #map { height: 100%; width: 100%; background: #111; }
        
        .drone-overlay { 
            position: absolute; top: 10px; right: 10px; z-index: 999; 
            background: rgba(0,0,0,0.9); padding: 5px 12px; 
            font-size: 0.75rem; border: 1px solid var(--accent); 
            color: var(--accent); border-radius: 4px;
        }

        /* BUTTON */
        .action-btn { 
            background: linear-gradient(135deg, #222, #111); 
            color: #fff; border: 1px solid #555; 
            padding: 15px; width: 100%; 
            border-radius: 8px; cursor: pointer; 
            font-family: inherit; font-weight: bold; font-size: 1rem;
            display: flex; justify-content: center; align-items: center; gap: 10px;
            transition: all 0.2s;
            box-shadow: 0 4px 0 #000;
        }
        .action-btn:active { transform: translateY(4px); box-shadow: 0 0 0 #000; }

        /* ANIMATIONS */
        .critical-alert { animation: pulse-red 0.8s infinite; border-color: var(--alert) !important; box-shadow: 0 0 15px var(--alert); }
        @keyframes pulse-red { 50% { border-color: #fff; } }
    </style>
</head>
<body>

    <div id="main-ui">
        <header>
            <div><i class="fas fa-satellite-dish"></i> SONA-OS v0.0.3</div>
            <div id="clock">SYS: ONLINE</div>
        </header>

        <!-- 1. HERO CARD (Face & Stats) -->
        <div class="hero-card">
            <div class="avatar-area">
                <!-- Image -->
                <img id="sona-face" src="./assets/avatar/nominal.png" class="sona-img" 
                     onerror="this.onerror=null; this.src='./assets/avatar/nominal.png';">
                
                <!-- Text -->
                <div id="sona-msg" class="sona-msg">
                    Target acquired.<br>
                    Habitat condition is stable.
                </div>
            </div>

            <!-- Metrics -->
            <div class="metrics-area">
                <div class="metric-row">
                    <span><i class="fas fa-tint"></i> H2O</span> 
                    <div class="bar-bg"><div id="b-water" class="bar-fill"></div></div> 
                    <span id="v-water" class="val-text">100%</span>
                </div>
                <div class="metric-row">
                    <span><i class="fas fa-bolt"></i> PWR</span> 
                    <div class="bar-bg"><div id="b-power" class="bar-fill"></div></div> 
                    <span id="v-power" class="val-text">100%</span>
                </div>
            </div>
        </div>

        <!-- 2. CONTROL -->
        <button class="action-btn" py-click="tick">
            <i class="fas fa-forward"></i> FAST FORWARD (+1h)
        </button>

        <!-- 3. MAP WIDGET (Square) -->
        <div class="map-card">
            <div id="map"></div>
            <div class="drone-overlay">
                <i class="fas fa-helicopter"></i> AETOS: <span id="drone-status">STANDBY</span>
            </div>
        </div>
    </div>

    <!-- MAP JS -->
    <script>
        let map, droneMarker;
        const HOME = [35.8617, 139.9711];
        
        window.onload = function() { setTimeout(initMap, 200); }; // 少し待ってから描画

        function initMap() {
            map = L.map('map', {zoomControl: false, attributionControl: false}).setView(HOME, 15);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                subdomains: 'abcd', maxZoom: 19
            }).addTo(map);
            
            const icon = L.divIcon({
                className: 'drone-icon', 
                html: '<i class="fas fa-crosshairs" style="color:#0f0; font-size:20px;"></i>'
            });
            droneMarker = L.marker(HOME, {icon: icon}).addTo(map);
        }

        function moveDrone(lat, lon) { 
            if(droneMarker) { droneMarker.setLatLng([lat, lon]); map.panTo([lat, lon]); }
        }
    </script>

    <!-- PYTHON LOGIC -->
    <script type="py">
        from pyscript import document
        import random
        import asyncio
        import js

        state = {"water": 100.0, "power": 100.0, "is_flying": False}

        # --- AVATAR CONTROLLER ---
        def update_avatar(w, p, is_flying):
            img_el = document.getElementById("sona-face")
            base_path = "./assets/avatar/"
            
            if is_flying:
                target = "compute.png"
                img_el.classList.remove("critical-alert")
            elif w < 20 or p < 20:
                target = "critical.png"
                img_el.classList.add("critical-alert")
            elif w < 40 or p < 40:
                target = "strain.png"
                img_el.classList.remove("critical-alert")
            elif w > 80 and p > 80:
                target = "optimal.png"
                img_el.classList.remove("critical-alert")
            else:
                target = "nominal.png"
                img_el.classList.remove("critical-alert")

            img_el.src = base_path + target

        # --- AETOS LOGIC ---
        async def call_drone_delivery():
            if state["is_flying"]: return
            state["is_flying"] = True
            
            update_avatar(state["water"], state["power"], True)
            document.getElementById("drone-status").innerText = "IN TRANSIT"
            document.getElementById("drone-status").style.color = "#00ff41"
            
            home = (35.8617, 139.9711)
            depot = (35.8650, 139.9750)
            steps = 30
            
            # Go
            for i in range(steps):
                lat = home[0] + (depot[0] - home[0]) * (i/steps)
                lon = home[1] + (depot[1] - home[1]) * (i/steps)
                js.moveDrone(lat, lon)
                await asyncio.sleep(0.05)
            
            await asyncio.sleep(1) # Loading
            
            # Return
            for i in range(steps):
                lat = depot[0] - (depot[0] - home[0]) * (i/steps)
                lon = depot[1] - (depot[1] - home[1]) * (i/steps)
                js.moveDrone(lat, lon)
                await asyncio.sleep(0.05)
                
            document.getElementById("drone-status").innerText = "STANDBY"
            document.getElementById("drone-status").style.color = "#e0e0e0"
            state["is_flying"] = False
            state["water"] = 100.0
            state["power"] = 100.0
            
            update_ui()
            set_msg("Resupply complete.\nSurvival probability restored.", "#00ffff")

        # --- UI UPDATE ---
        def update_ui():
            w = state['water']
            p = state['power']
            
            document.getElementById("b-water").style.width = f"{w}%"
            document.getElementById("v-water").innerText = f"{int(w)}%"
            document.getElementById("b-water").style.background = "#ff0055" if w < 20 else "#00ff41"

            document.getElementById("b-power").style.width = f"{p}%"
            document.getElementById("v-power").innerText = f"{int(p)}%"
            document.getElementById("b-power").style.background = "#ff0055" if p < 20 else "#00ff41"

            update_avatar(w, p, state["is_flying"])

        def set_msg(msg, color="#fff"):
            el = document.getElementById("sona-msg")
            el.innerText = msg
            el.style.color = color

        def tick(e):
            is_sunny = random.random() > 0.5
            state["water"] = max(0, state["water"] - 15)
            
            if is_sunny:
                state["power"] = min(100, state["power"] + 10)
                status = "(SUN)"
            else:
                state["power"] = max(0, state["power"] - 15)
                status = "(CLOUD)"

            if state["water"] < 20 or state["power"] < 20:
                set_msg("CRITICAL ALERT:\nResources depleted. Requesting drone.", "#ff0055")
                asyncio.create_task(call_drone_delivery())
            else:
                if state["water"] < 40:
                    set_msg("Water level low.\nPlease conserve usage.", "#ffaa00")
                elif state["power"] > 90:
                    set_msg(f"Battery fully charged.\nEfficiency is optimal. {status}", "#00ff41")
                else:
                    set_msg(f"Systems nominal.\nHabitat is secure. {status}", "#e0e0e0")
            
            update_ui()
    </script>
</body>
</html>
